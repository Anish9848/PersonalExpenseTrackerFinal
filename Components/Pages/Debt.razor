@page "/debt"
@using PersonalExpenseTracker.Models
@inject PersonalExpenseTracker.Services.DebtService DebtService

<h1>Debts</h1>

<!-- Filter and Search Inputs -->
<div class="d-flex justify-content-end mb-3">
    <div class="me-3">
        <input type="text" @bind="SearchSource" @oninput="SearchDebts" class="form-control" placeholder="Search by Source" />
    </div>
    <div>
        <button @onclick="ToggleFilterPopup" class="btn btn-primary">Filter</button>
    </div>
</div>

<!-- Button to Toggle the Add Debt Form -->
<button @onclick="ToggleFormVisibility" class="btn btn-primary add-debt-button position-fixed bottom-0 end-0 m-3">
    Add Debt
</button>

<!-- Modal for Add Debt -->
@if (ShowForm)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@((DebtToEdit == null) ? "Add Debt" : "Edit Debt")</h5>
                    <button type="button" class="btn-close" @onclick="ToggleFormVisibility"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(WarningMessage))
                    {
                        <div class="alert alert-warning" role="alert">
                            @WarningMessage
                        </div>
                    }
                    <div class="mb-3">
                        <label for="Source" class="form-label">Source</label>
                        <input id="Source" @bind="NewSource" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount</label>
                        <input id="amount" @bind="NewDebtAmount" type="number" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label for="dueDate" class="form-label">Due Date</label>
                        <input id="dueDate" @bind="NewDueDate" type="date" class="form-control" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button @onclick="AddOrUpdateDebt" class="btn btn-primary">@((DebtToEdit == null) ? "Add Debt" : "Update Debt")</button>
                    <button type="button" class="btn btn-secondary" @onclick="ToggleFormVisibility">Close</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Modal for Date Filter -->
@if (ShowFilterPopup)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Filter Debts</h5>
                    <button type="button" class="btn-close" @onclick="ToggleFilterPopup"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="filterDate" class="form-label">Select Debt Taken Date</label>
                        <input type="month" id="filterDate" @bind="FilterDate" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label for="filterStatus" class="form-label">Select Status</label>
                        <select id="filterStatus" @bind="FilterStatus" class="form-control">
                            <option value="">All</option>
                            <option value="Pending">Pending</option>
                            <option value="Paid">Paid</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button @onclick="FilterDebts" class="btn btn-primary">Apply Filter</button>
                    <button @onclick="ClearFilter" class="btn btn-secondary">Clear</button>
                    <button type="button" class="btn btn-secondary" @onclick="ToggleFilterPopup">Close</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Modal for Paying Debt -->
@if (ShowPayPopup)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Pay Debt</h5>
                    <button type="button" class="btn-close" @onclick="TogglePayPopup"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(PayWarningMessage))
                    {
                        <div class="alert alert-warning" role="alert">
                            @PayWarningMessage
                        </div>
                    }
                    <div class="mb-3">
                        <label for="payAmount" class="form-label">Amount to Pay</label>
                        <input id="payAmount" @bind="PayAmount" type="number" class="form-control" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button @onclick="PayDebt" class="btn btn-primary">Pay</button>
                    <button type="button" class="btn btn-secondary" @onclick="TogglePayPopup">Close</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Debt Table -->
<table class="table table-striped mt-4">
    <thead class="table-dark">
        <tr>
            <th>S.No.</th>
            <th>Source</th>
            <th>Due Date</th>
            <th>Status</th>
            <th>Amount</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var debt in FilteredDebts.Select((debt, index) => new { debt, index }))
        {
            <tr>
                <td>@(debt.index + 1)</td>
                <td>@debt.debt.DebtSource</td>
                <td>@debt.debt.DebtTakenDate.ToShortDateString() - @debt.debt.DebtDueDate.ToShortDateString()</td>
                <td>@debt.debt.Status</td>
                <td>@debt.debt.DebtAmount</td>
                <td>
                    <button @onclick="() => EditDebt(debt.debt)" class="btn btn-success btn-sm">Edit</button>
                    <button @onclick="() => ShowPayDebtPopup(debt.debt)" class="btn btn-primary btn-sm">Pay</button>
                    <button @onclick="() => ConfirmDelete(debt.debt)" class="btn btn-danger btn-sm">Delete</button>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- Confirmation Modal for Deleting Debt -->
@if (ShowDeleteConfirmation)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Deletion</h5>
                    <button type="button" class="btn-close" @onclick="CancelDelete"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the debt "<strong>@DebtToDelete?.DebtSource</strong>"?</p>
                </div>
                <div class="modal-footer">
                    <button @onclick="DeleteDebt" class="btn btn-danger">Delete</button>
                    <button type="button" class="btn btn-secondary" @onclick="CancelDelete">Cancel</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Debtitem> Debts = new();
    private List<Debtitem> FilteredDebts = new();
    private string NewSource = string.Empty;
    private decimal NewDebtAmount;
    private DateTime NewDueDate = DateTime.Now;
    private bool ShowForm = false;
    private bool ShowPayPopup = false;
    private bool ShowFilterPopup = false;
    private bool ShowDeleteConfirmation = false;
    private Debtitem? DebtToEdit;
    private Debtitem? DebtToPay;
    private Debtitem? DebtToDelete;
    private decimal PayAmount;
    private string? WarningMessage;
    private string? PayWarningMessage;
    private DateTime? FilterDate;
    private string FilterStatus = string.Empty;
    private string SearchSource = string.Empty;

    protected override void OnInitialized()
    {
        LoadDebts();
    }

    private void ToggleFormVisibility()
    {
        ShowForm = !ShowForm;
        if (!ShowForm)
        {
            ClearForm();
        }
    }

    private void TogglePayPopup()
    {
        ShowPayPopup = !ShowPayPopup;
        if (!ShowPayPopup)
        {
            PayAmount = 0;
            PayWarningMessage = string.Empty;
        }
    }

    private void ToggleFilterPopup()
    {
        ShowFilterPopup = !ShowFilterPopup;
    }

    private void AddOrUpdateDebt()
    {
        // Check if any required fields are empty
        if (string.IsNullOrEmpty(NewSource) || NewDebtAmount <= 0 || NewDueDate == default)
        {
            WarningMessage = "Please fill in all fields!";
            return;
        }

        if (DebtToEdit == null)
        {
            // Add a new debt
            DebtService.AddDebt(new Debtitem
                {
                    DebtSource = NewSource,
                    DebtAmount = NewDebtAmount,
                    DebtDueDate = NewDueDate,
                    DebtTakenDate = NewDueDate, // Set DebtTakenDate to the same as DebtDueDate
                    Status = "Pending"
                });
        }
        else
        {
            // Update existing debt
            DebtToEdit.DebtSource = NewSource;
            DebtToEdit.DebtAmount = NewDebtAmount;
            DebtToEdit.DebtDueDate = NewDueDate;
            DebtToEdit.DebtTakenDate = NewDueDate; // Set DebtTakenDate to the same as DebtDueDate
            DebtToEdit.Status = "Pending";
            DebtService.UpdateDebt(DebtToEdit);
            DebtToEdit = null;
        }

        LoadDebts();
        ClearForm();
        ShowForm = false;
        WarningMessage = string.Empty; // Clear any warning message after adding/updating
    }

    private void EditDebt(Debtitem debt)
    {
        DebtToEdit = debt;
        NewSource = debt.DebtSource;
        NewDebtAmount = debt.DebtAmount;
        NewDueDate = debt.DebtDueDate;
        ShowForm = true;
    }

    private void ShowPayDebtPopup(Debtitem debt)
    {
        DebtToPay = debt;
        ShowPayPopup = true;
    }

    private void PayDebt()
    {
        if (DebtToPay != null)
        {
            if (PayAmount <= 0 || PayAmount > DebtToPay.DebtAmount)
            {
                PayWarningMessage = "Amount is greater than the debt amount!";
                return;
            }

            DebtToPay.DebtAmount -= PayAmount;
            if (DebtToPay.DebtAmount == 0)
            {
                DebtToPay.Status = "Paid";
            }

            DebtService.UpdateDebt(DebtToPay);
            LoadDebts();
            ShowPayPopup = false;
            DebtToPay = null;
            PayAmount = 0;
            PayWarningMessage = string.Empty; // Clear any warning message after payment
        }
    }

    private void ConfirmDelete(Debtitem debt)
    {
        DebtToDelete = debt;
        ShowDeleteConfirmation = true;
    }

    private void DeleteDebt()
    {
        if (DebtToDelete != null)
        {
            DebtService.DeleteDebt(DebtToDelete.DebtId);
            LoadDebts();
            ShowDeleteConfirmation = false;
            DebtToDelete = null;
        }
    }

    private void CancelDelete()
    {
        ShowDeleteConfirmation = false;
        DebtToDelete = null;
    }

    private void LoadDebts()
    {
        Debts = DebtService.GetDebts();
        FilteredDebts = Debts; // Initialize FilteredDebts
    }

    private void ClearForm()
    {
        NewSource = string.Empty;
        NewDebtAmount = 0;
        NewDueDate = DateTime.Now;
        DebtToEdit = null;
        WarningMessage = string.Empty;
    }

    private void FilterDebts()
    {
        FilteredDebts = Debts;

        if (FilterDate.HasValue)
        {
            FilteredDebts = FilteredDebts.Where(d => d.DebtTakenDate.Month == FilterDate.Value.Month && d.DebtTakenDate.Year == FilterDate.Value.Year).ToList();
        }

        if (!string.IsNullOrEmpty(FilterStatus))
        {
            FilteredDebts = FilteredDebts.Where(d => d.Status == FilterStatus).ToList();
        }

        ShowFilterPopup = false; // Close the filter popup after applying the filter
    }

    private void ClearFilter()
    {
        FilterDate = null;
        FilterStatus = string.Empty;
        FilteredDebts = Debts;
    }

    private void SearchDebts(ChangeEventArgs e)
    {
        SearchSource = e.Value.ToString();
        if (!string.IsNullOrEmpty(SearchSource))
        {
            FilteredDebts = Debts.Where(d => d.DebtSource.Contains(SearchSource, StringComparison.OrdinalIgnoreCase)).ToList();
        }
        else
        {
            FilteredDebts = Debts;
        }
    }
}